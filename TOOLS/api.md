



# Збір фінансових даних за допомогою Python API (безпечно)

https://medium.com/data-science-collective/gather-tons-of-financial-data-with-python-apis-safely-e25d2705b4b7

## Вступ

Фінансові дані є надзвичайно поширеними, але для їх ефективного збору потрібно застосовувати розумний підхід. Уявіть, що вам потрібно дослідити, як творча індустрія розвивається після появи штучного інтелекту. Ви склали список компаній цього сектору — Netflix, Warner Bros, Spotify, Adobe тощо — і тепер потрібно отримати їхні фінансові дані.

Найшвидший спосіб зібрати ці дані — це використання API, таких як yfinance та інші. Однак багато користувачів швидко досягають обмежень безкоштовного доступу і змушені платити або взагалі втрачають доступ.

## Чому постачальники даних встановлюють обмеження

Існує кілька причин, чому API мають обмеження:

1. **Захист інфраструктури**: Сервери обробляють мільйони запитів щодня, без обмежень вони перевантажувались би.
   
2. **Стимулювання платних підписок**: Постачальники даних надають достатньо інформації безкоштовно, щоб ви зрозуміли цінність послуги, але обмежують доступ, спонукаючи до придбання платного тарифу.
   
3. **Дотримання законодавства**: Фінансова галузь суворо регулюється, і постачальники даних повинні дотримуватися нормативних правил.

## Огляд постачальників фінансових даних

- **yfinance**: Найщедріший, дозволяє 2000 API-запитів на день. Найкращий для даних про акції та історичної інформації.
  
- **IEX Cloud і EOD Historical Data (EODHD)**: Також щедрі, підходять для даних ринку в реальному часі та високошвидкісних запитів.
  
- **Alpha Vantage, Polygon.io, Quandl**: Середній рівень щедрості, підходять для нерегулярного використання.
  
- **Alpaca і Codat**: Найменш щедрі. Alpaca найкраще підходить для торгових ботів, Codat масштабується з кількістю підключених компаній.

## Стратегія №1: Групування запитів

Як спекти більше печива без додаткового часу? Роблячи більші партії. Те саме стосується API-запитів.

Більшість API дозволяють групові запити. Ось приклад групового запиту для трьох тікерів в yfinance:

```python
import yfinance as yf

# Отримання даних для кількох тікерів одним запитом
tickers = ["AAPL", "GOOG", "MSFT"]
data = yf.download(tickers, period="1y", interval="1d")
print(data.head())
```

## Стратегія №2: Паузи між запитами

Навіть при групуванні запитів, вам може знадобитися кілька викликів API. Більшість фінансових API не дозволяють необмежену кількість швидких запитів.

Наслідки недотримання обмежень можуть варіюватися від повідомлень про помилку до тимчасового блокування вашої IP-адреси або навіть постійного позбавлення доступу.

Найкращий обхідний шлях — встановлення пауз між запитами з допомогою `time.sleep()`:

```python
import time
import requests

API_KEY = "ваш_api_ключ"
symbols = ["AAPL", "GOOG", "MSFT", "AMZN", "TSLA"]

def fetch_stock_data(symbol):
    url = f"https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol={symbol}&apikey={API_KEY}"
    response = requests.get(url)
    return response.json()

for symbol in symbols:
    data = fetch_stock_data(symbol)
    print(f"Отримано дані для {symbol}")
    time.sleep(12)  # Alpha Vantage дозволяє 5 запитів на хвилину
```

## Стратегія №3: Ротація API-ключів

Деякі API обмежують запити за ключем, а не за користувачем чи IP-адресою. У такому випадку ви можете створити кілька API-ключів і розподілити запити між ними.

Перевірте документацію API перед використанням цієї стратегії. Наприклад, Alpha Vantage не обмежує кількість ключів, а Polygon.io цього не допускає.

Базовий спосіб ротації ключів:

```python
import random

API_KEYS = ["ключ1", "ключ2", "ключ3"]
BASE_URL = "https://api.example.com/stock"

def fetch_data(symbol):
    api_key = random.choice(API_KEYS)  # Випадковий вибір ключа
    url = f"{BASE_URL}?symbol={symbol}&apikey={api_key}"
    return requests.get(url).json()

data = fetch_data("AAPL")
print(data)
```

## Стратегія №4: Використання проксі-серверів

Деякі API встановлюють обмеження за IP-адресою, а не за ключем. У такому випадку, навіть якщо ви застосовуєте ротацію ключів, ви все одно можете бути заблоковані.

Рішення — розподіл трафіку через кілька IP-адрес за допомогою проксі-серверів. Приклад налаштування:

```python
import requests

proxies = {
    "http": "http://proxy.example.com:8080",
    "https": "https://proxy.example.com:8080",
}

response = requests.get("https://api.example.com/data", proxies=proxies)
print(response.json())
```

Перевірте умови використання API, оскільки деякі з них прямо забороняють використання проксі для обходу обмежень.

## Стратегія №5: Кешування відповідей API

Ви не хочете повторно запитувати дані, які вже отримували раніше. Кешування допомагає зберігати попередні відповіді локально, зменшуючи кількість непотрібних API-запитів і покращуючи швидкість.

Найпростіший спосіб кешування з використанням pickle:

```python
import pickle
import requests

def fetch_and_cache(symbol):
    cache_file = f"{symbol}.pkl"
    try:
        # Завантаження кешованих даних, якщо вони доступні
        with open(cache_file, "rb") as f:
            data = pickle.load(f)
            print(f"Завантажено кешовані дані для {symbol}")
            return data
    except FileNotFoundError:
        # Запит до API, якщо кеш відсутній
        url = f"https://api.example.com/stock/{symbol}"
        data = requests.get(url).json()
        # Збереження в кеш
        with open(cache_file, "wb") as f:
            pickle.dump(data, f)
        
        return data

data = fetch_and_cache("AAPL")
```

## Підсумок

Впровадження цих стратегій може зайняти певний час, але це варто зусиль, якщо це дозволить вам залишатися на безкоштовному тарифі. Тепер ви знаєте правила гри і можете використовувати їх на свою користь, групуючи запити, встановлюючи паузи, застосовуючи ротацію API-ключів, використовуючи проксі-сервери та кешуючи дані.

Для подальшої автоматизації збору даних ви можете дослідити паралельні запити або безсерверні функції. Якщо вам потрібні альтернативні дані, можливо, вам доведеться вивчити техніки веб-скрапінгу або вилучення даних з PDF-файлів.


# ПОСИЛАННЯ:
- Learn FastAPI with a Full-Stack Project: Movie Recommendation, https://medium.com/data-science-collective/learn-fastapi-with-a-full-stack-project-movie-recommendation-71df04317bfd
- API Protocols Explained: When to Use HTTP, WebSockets, gRPC & More, https://levelup.gitconnected.com/api-protocols-explained-when-to-use-http-websockets-grpc-more-bea2132741bb
- 


